package com.bird.vector;

import com.bird.vector.EmIndex;
import com.bird.vector.EmPQ;
import com.bird.vector.common.VectorTools;
import com.bird.vector.utils.ArrayTools;
import com.bird.vector.utils.Separators;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.tuple.Pair;

import java.lang.management.ManagementFactory;
import java.lang.management.MemoryMXBean;
import java.util.Arrays;
import java.util.List;

/**
 * Created with IntelliJ IDEA.
 *
 * @description：
 * @author： liuxiangqian
 * @date： 2024/10/18
 */
@Slf4j
public class EmIndexTest {
    private static double[] vector = {1.3634402, 3.6105103, 1.8464756, 4.5035434, 7.2112055, 4.8343735, 1.3022077,
            0.32176137, 5.2726626, 4.7317963, 9.114375, 8.804062, 8.7977295, 3.9878635, 0.63620985, 5.7161326,
            7.7457037, 5.369735, 0.46878755, 5.3250265, 6.0829144, 5.9429793, 9.830854, 1.1372709, 0.09596825,
            5.054268, 1.4055216, 6.149296, 0.9755397, 2.3288293, 1.1565173, 9.652658, 4.7292047, 8.884237, 2.9473925,
            7.734997, 0.38158894, 7.3508787, 4.813135, 0.77384055, 5.30103, 2.55338, 8.325576, 4.576935, 3.894937,
            9.817022, 1.4682752, 9.303365, 2.5383754, 3.8206995, 4.0063, 7.109687, 1.7956513, 9.256485, 4.620419,
            1.5906739, 4.272517, 8.8398075, 4.5992985, 8.792871, 7.963168, 2.5393372, 1.078791, 5.9196706, 6.053636,
            9.388821, 7.522368, 3.149165, 2.7900834, 4.5626097, 3.0951881, 0.36199272, 4.351591, 6.2318134, 9.946739,
            1.4182067, 4.473336, 0.28966904, 6.239914, 7.1038823, 7.7948833, 4.5948095, 7.5108757, 5.444627,
            3.1630647, 5.7127595, 2.983057, 6.990843, 3.159541, 0.053730607, 1.5657008, 8.435991, 1.3654429,
            2.1542912, 3.1240063, 1.8331182, 1.8919116, 7.008679, 9.30214, 8.306551, 5.724307, 1.7306656, 8.706216,
            4.8763466, 9.834139, 7.358391, 9.012271, 4.4652505, 9.847413, 1.7731339, 2.8608847, 1.765585, 7.518337,
            3.9906378, 0.9482348, 9.111536, 5.196664, 2.533387, 9.142373, 5.317206, 0.90527, 2.268815, 2.7684915,
            8.370081, 7.227674, 5.597277, 0.34977376, 7.4620175, 2.7655828, 2.82191, 7.3988657, 6.92562, 6.942561,
            0.08827567, 3.5732512, 0.8342767, 3.0364168, 0.6344843, 0.28621733, 2.211656, 3.810836, 9.962974,
            1.2603569, 0.65508723, 2.433496, 8.685281, 2.4854894, 0.6619108, 4.616828, 8.484133, 6.4666996, 4.795021,
            7.358544, 9.19749, 5.796242, 9.050923, 4.2080526, 5.3025103, 4.136973, 6.199601, 5.714147, 1.9406861,
            6.252706, 8.530322, 8.347474, 7.4868574, 9.256491, 7.2226515, 2.622956, 6.963891, 2.6717412, 7.609837,
            5.9136143, 8.312227, 7.0200233, 9.836297, 2.2453804, 8.641162, 7.6760178, 3.0372386, 7.5459867, 6.649907,
            9.783857, 9.172782, 6.8996854, 8.975583, 9.6350975, 4.298914, 0.4993391, 5.3979993, 0.49865603,
            0.40205002, 7.510685, 0.73445797, 5.3049917, 8.292927, 4.9487095, 9.549884, 2.5648332, 0.5603951,
            0.04797697, 5.1779885, 4.597175, 5.61894, 5.278324, 3.2184947, 1.608783, 7.619304, 1.061933, 4.8956394,
            0.8709055, 8.884485, 0.9908569, 0.21754324, 5.5474706, 8.819938, 1.6854292, 9.57889, 2.4181037, 6.4446306
            , 5.7896194, 4.646528, 5.4905043, 9.097537, 3.541562, 1.4359736, 3.3979356, 2.0721722, 0.11473715,
            6.3345675, 1.522978, 8.281362, 1.8823558, 7.3937087, 5.3786287, 2.198068, 1.9553918, 0.9688157, 4.2189837
            , 2.6795812, 0.9807551, 7.2334332, 3.8569422, 7.5668983, 3.1137424, 6.266383, 4.8548574, 2.6449175,
            4.3079257, 0.3725499, 7.6511025, 5.419714, 3.2621245, 3.6444445, 4.722857, 2.7655907, 7.3501883, 9.130108
            , 2.9009204, 1.6467202, 2.1136637, 9.501357, 6.690096, 5.437517, 4.0546536, 3.0043201, 7.559163, 9.744823
            , 0.8174437, 1.4423722, 0.20422518, 1.7474997, 8.839899, 6.7418594, 6.7211847, 4.8701243, 7.2929006,
            2.5666804, 4.316472, 5.833477, 4.867794, 4.793236, 3.9151816, 6.7930613, 6.6341043, 1.2782663, 1.9742936,
            0.18675566, 5.8448462, 6.1255074, 8.563337, 5.1439333, 6.9431276, 4.99124, 2.83005, 9.7224455, 3.006205,
            6.3030267, 5.224523, 3.9791508, 2.9927163, 3.5709977, 1.1187291, 1.868155, 1.1327219, 8.248883, 5.942088,
            0.4036349, 4.9719687, 2.3858113, 9.776911, 8.407351, 7.4612465, 9.164157, 3.045693, 3.752336, 7.234773,
            5.439098, 1.906786, 2.362587, 5.170574, 8.7090435, 6.093997, 7.663954, 2.4492598, 6.2108636, 5.9331913,
            9.815151, 8.76027, 2.7393703, 3.2954354, 7.2725077, 9.83753, 7.557498, 1.35827, 2.231506, 2.0868068,
            7.6439757, 4.707186, 7.69747, 2.2984486, 2.3023045, 7.8874893, 9.603223, 1.0812712, 2.6428723, 1.7878306,
            8.030779, 6.1223145, 2.9948564, 1.8824065, 8.505938, 2.2451186, 1.2830836, 5.4670963, 7.0991063, 8.734699
            , 2.72547, 0.5897051, 2.044189, 4.905253, 8.808461, 2.796471, 3.4223337, 4.44782, 8.8517885, 6.402664,
            0.57282805, 9.906942, 9.081793, 0.45734584, 1.9942898, 5.551264, 8.027676, 0.5303687, 3.0720024, 9.932881
            , 3.3019214, 1.92877, 4.7793508, 6.239946, 4.0203166, 7.8816056, 9.101568, 6.958946, 2.8855677, 3.954752,
            0.14860272, 9.8556795, 9.459638, 2.714529, 0.3720969, 0.49197674, 0.5730009, 7.1014643, 8.871839,
            5.7097445, 8.884841, 7.659827, 9.143475, 6.182165, 7.06866, 4.6575813, 0.73673844, 0.3573674, 3.2360792,
            7.0942564, 7.8984175, 8.16242, 5.3422604, 3.906376, 6.3841634, 9.61105, 5.2849627, 9.523046, 1.0370696,
            0.03931701, 1.0929048, 3.8860917, 3.5285668, 1.8081713, 1.4058381, 2.6238294, 4.7001452, 8.845025,
            5.8181386, 4.1554985, 5.3751063, 9.889335, 7.560446, 8.911393, 5.251954, 3.4568696, 8.431871, 9.794425,
            1.7501277, 9.697424, 6.401775, 9.601662, 0.44092238, 4.0009384, 2.4395175, 8.894464, 0.22924781, 4.573365
            , 7.9986567, 9.184999, 9.804093, 1.5784234, 8.305678, 0.13291538, 5.377367, 1.8030894, 8.84081, 3.4630394
            , 2.4933994, 8.288144, 4.8391237, 9.673455, 9.107503, 4.761224, 2.504779, 9.359893, 1.3753235, 5.965971,
            9.171802, 8.599873, 4.120421, 5.7005444, 0.64439774, 5.6877193, 1.9919103, 8.321621, 2.2230566, 4.3646326
            , 5.4046135, 8.052242, 4.815116, 0.228315, 3.769899, 5.2255893, 5.417162, 2.3219109, 1.8562651, 3.830566,
            8.049737, 9.9864645, 8.72609, 9.7837105, 4.8617773, 6.315122, 1.2214053, 1.2764317, 0.07379651, 8.2774935
            , 9.840884, 8.534141, 1.1968321, 0.5018747, 6.767542, 0.2280873, 1.5820515, 4.4305687, 7.2582474,
            2.6112885, 6.8878536, 8.124651, 3.3596368, 7.872956, 1.093204, 9.320935, 5.5192094, 3.0435305, 7.864652,
            6.7734356, 3.9453745, 5.5132794, 2.558241, 2.6884418, 9.147303, 6.4862556, 3.09578, 3.836866, 4.847236,
            7.7692127, 3.118424, 6.2563124, 7.078199, 8.639097, 3.9410853, 0.30140758, 9.713986, 9.246526, 8.192208,
            0.033304095, 8.662112, 1.3559568, 4.939189, 5.833417, 7.5017505, 0.1120919, 5.4160376, 7.8639894,
            5.2663846, 6.028683, 9.06361, 3.166864, 9.434933, 1.248852, 9.872195, 2.2860723, 1.8669748, 0.2100563,
            3.4207625, 5.219866, 3.5398154, 1.7029661, 0.5075699, 8.060275, 2.4414194, 6.6389647, 5.864975, 4.0760946
            , 3.048755, 5.9893703, 1.68042, 8.357479, 1.462152, 3.8404548, 9.070149, 6.9924693, 6.7404532, 6.4879823,
            4.3679, 7.5194354, 1.3379014, 5.2955875, 6.2246175, 0.9324908, 5.1118846, 6.641306, 8.72534, 9.553507,
            2.2622042, 9.810792, 1.7052186, 3.7749152, 6.170023, 3.9552097, 3.4089506, 2.0785522, 6.601922, 9.163688,
            0.8385676, 7.3103952, 8.586588, 7.90816, 7.356847, 1.3081813, 4.69495, 0.36211252, 5.1719403, 4.4140673,
            7.9766245, 6.7902136, 6.5689707, 4.8392773, 2.7251506, 8.92534, 3.553145, 0.3700024, 4.141782, 9.221583,
            1.8347132, 5.507801, 6.2038774, 6.4812536, 4.7582245, 6.223777, 3.261773, 0.6416148, 3.3277206, 1.3805491
            , 4.511265, 0.6705159, 4.4077587, 0.25235474, 9.222525, 2.4125123, 4.520593, 4.070661, 2.936803,
            7.8585052, 7.4770164, 2.165833, 2.5371594, 1.3481927, 0.96786916, 9.996336, 8.707545, 9.478102, 7.8321323
            , 3.493508, 3.645991, 0.45713186, 9.1639, 6.946327, 6.603603, 0.9611273, 7.913972, 6.757107, 9.7743025,
            7.479105, 6.9029255, 1.3724613, 7.9344444, 8.163544, 4.943257, 5.4969196, 0.9817618, 6.3992367, 9.351862,
            0.19853175, 3.8858175, 9.949264, 4.8350196, 6.991954, 1.5549111, 8.5387745, 4.3920064, 4.6165853,
            0.5459392, 7.1696796, 1.3873839, 9.603133, 7.4742136, 4.050543, 6.694084, 2.335751, 8.280958, 7.6608305,
            6.249118, 7.06894, 9.329769, 1.6880167, 2.4617589, 9.055393, 2.5534816, 4.077322, 4.6723843, 2.7958095,
            2.764842, 4.570513, 5.8119135, 9.553524, 6.7643113, 6.3919425, 3.1215334, 8.210949, 5.293948, 2.332958,
            3.355751, 3.7130551, 0.24636328, 3.712157, 7.435768, 0.5831772, 9.172324, 5.5272665, 5.7029243, 3.0525756
            , 6.151057, 0.6994188, 4.432938, 7.367738, 4.886169, 6.4333224, 3.3316355, 8.885036, 4.641302, 2.3245187,
            5.593689, 6.093958, 8.788134, 1.541127, 9.550845, 4.0968113, 6.541531, 6.951961, 8.779646, 1.0899985,
            1.4201212, 4.8816357, 5.1264114, 6.7212873, 1.3940656, 1.8185979, 2.8162427, 0.92683315, 0.1455152,
            8.112377, 7.5512276, 4.975239, 1.7324138, 6.8565454, 0.21030068, 3.363996, 0.85555434, 2.804916,
            2.9100788, 0.23291469, 2.3059428, 2.5076568, 5.2743697, 7.792512, 8.719642, 2.734775, 9.823177, 6.531888,
            8.976685, 4.6865935, 8.494328, 8.695833, 7.216947, 9.140413, 3.0480237, 2.636363, 7.0578756, 5.371805,
            3.1036806, 7.4874682, 8.016756, 9.896407, 8.977452, 5.4277797, 2.9751372, 0.43849468, 6.5174527, 4.234419
            , 1.6675782, 4.3369603, 6.492415, 1.4491892, 6.305065, 7.2949033, 7.530509, 5.2383957, 0.5101198,
            9.069425, 4.411256, 6.799019, 1.4822805, 3.6430306, 9.999621, 7.2221894, 0.7468003, 6.53349, 1.1229581,
            4.2514873, 9.764868, 5.257151, 5.105514, 3.9564676, 0.1805675, 7.290242, 2.900012, 0.4750651, 2.4094253,
            5.0582714, 7.2306104, 6.5626535, 1.7783391, 9.066299, 4.857287, 5.5270224, 5.4307823, 7.959929, 2.9901295
            , 4.4404335, 0.9194994, 0.43174446, 2.5564651, 1.4212459, 4.807783, 5.970502, 9.018648, 9.793824,
            5.9574213, 4.656598, 2.851334, 6.4981403, 8.545352, 5.859457, 1.7411923, 5.067643, 7.552102, 9.769079,
            9.727393, 7.5695796, 8.614377, 7.329749, 1.5473729, 9.256588, 2.124548, 4.1299295, 4.6099734, 2.3685133,
            1.4647961, 3.0858226, 4.539047, 6.01204, 8.73863, 2.940588, 0.8982539, 0.7019603, 0.54358304, 3.4464579,
            7.336416, 3.7470949, 6.733732, 0.019007921, 9.328252, 3.8877864, 8.048163, 7.2239504, 4.304446, 5.5282016
            , 3.5115457, 0.905444, 4.1760883, 8.549778, 6.0071163, 7.475892, 2.0009418, 4.4422092, 8.022999, 7.901539
            , 0.28352797, 2.652185, 8.703851, 5.433075, 2.6495528, 8.340473, 5.706336, 4.999551, 7.420972, 8.774033,
            9.445271, 8.416818, 7.0054507, 6.3871, 4.894973, 0.8245957, 1.5988278, 2.0551486, 4.7262707, 7.881272,
            7.108371, 8.676276, 3.0438237, 0.6912768, 2.5963445, 7.9899983, 7.952227, 1.8510282, 1.1071539, 9.334026,
            3.5153615, 4.667099, 3.1977243, 8.302046, 3.0554974, 1.9716209, 5.5918956, 2.9826398, 0.12177527,
            7.1385784, 8.408524, 1.500513, 5.5782366, 9.150279, 5.6842375, 4.221382, 7.137142, 4.7919726, 2.2710574,
            8.403047, 5.0926995, 3.3365524, 9.513319, 9.865021, 7.0736246, 4.1490755, 5.8057146, 1.9019407, 8.191504,
            2.3771918, 1.6443282, 4.082058, 7.1582766, 6.8395324, 2.0758164, 4.558201, 5.704169, 2.0769465, 9.528582,
            7.287479, 8.152123, 0.6446475, 3.4068303, 7.2268863, 1.2825686, 4.606688, 8.10847, 0.6701946, 5.9207525,
            7.013676, 1.3864744, 6.8487935, 1.0467631, 5.222549, 0.33760428, 9.573267, 6.995733, 1.2321037, 2.4304314
            , 1.7877054, 5.5940094, 7.8945246, 5.5659246, 0.5953753, 4.2587714, 9.712431, 0.41911304, 8.649036,
            6.34757, 8.890256, 3.4914887, 9.244896, 7.8355627, 9.981501, 3.1941044, 5.384894, 7.9582734, 3.619475,
            8.695117, 7.25333, 9.303901, 2.8544247, 1.5486318, 1.67216, 7.270608, 6.116846, 9.651023, 1.2427425,
            4.4006786, 3.013661, 7.7545857, 9.044396, 7.226452, 2.4257426, 6.546016, 7.3422146, 0.5549848, 3.7528439,
            5.639362, 0.06496251, 1.003378, 8.842705, 4.241788, 9.561261, 0.77958465, 3.9984531, 5.7589417, 7.9479175
            , 7.670806, 3.492148, 0.27929902, 3.2535124, 4.7206516, 0.88843584, 7.309395, 5.4648933, 5.696073
    };


    private static float[] floatVector = ArrayTools.toFloatArr(vector);

    private static void memoryDetect() {
        //打印内存损耗
        MemoryMXBean memoryMXBean = ManagementFactory.getMemoryMXBean();
        log.info("heapMemoryUsage: {}", memoryMXBean.getHeapMemoryUsage().toString());
        log.info("nonHeapMemoryUsage: {}", memoryMXBean.getNonHeapMemoryUsage().toString());
    }

    public static void createIndexTest(EmPQ pq, String indexDir, String indexPrefix) {
        log.info("--------------增量添加数据与检索测试----------------");
        //构建向量索引类，并进行向量注入
        EmIndex emIndex = new EmIndex(pq);
        String csvFile = "data/test.txt";
        Pair<List<Integer>, List<float[]>> idsAndVectorsPair = VectorTools.laodIdsAndVectors(csvFile);
        List<float[]> vectors = idsAndVectorsPair.getValue();
        List<Integer> ids = idsAndVectorsPair.getKey();
        emIndex.addVector(vectors, ids);
        log.info("总向量数:{} ", vectors.size());

        log.info("---------------内存损耗------------------");
        //打印内存损耗
        memoryDetect();

        //向量索引存储与加载
        log.info("---------------存储索引-------------------------");
        emIndex.store(indexDir, indexPrefix);
    }

    public static void loadIndexTest(EmPQ pq, String indexDir, String indexPrefix, int clusterTopn, int topn) {
        EmIndex emIndex = new EmIndex(pq);
        emIndex.load(indexDir, indexPrefix);
        List<Pair<Integer, Float>> docs = emIndex.searchDocs(floatVector, clusterTopn, topn);
        for (int i = 0; i < docs.size(); i++) {
            Pair<Integer, Float> pair = docs.get(i);
            int id = pair.getKey();
            float dis = pair.getValue();

            List<float[]> vectors = emIndex.getIndexVectors().get(id);
            StringBuilder sb = new StringBuilder();
            for (int j = 0; j < vectors.size(); j++) {
                float[] vector = vectors.get(j);
                String embedding = Arrays.toString(vector);
                sb.append(embedding).append(Separators.COMMA);
            }
            log.info("id:{}  dis:{} embedding:{}", id, dis, sb.toString());
        }
    }

    public static void main(String[] args) {
        int pqSegmentCount = 16;
        int clusterCount = 16;
        int maxIterCount = 100;
        int vectorDimention = 1024;
        int clusterTopn = 3;
        int topn = 10;

        //初始化量化模型
        String modelDir = "pqmodel/";
        EmPQ pq = new EmPQ(pqSegmentCount, clusterCount, maxIterCount, vectorDimention);
        pq.load(modelDir);

        String indexDir = "index/";
        String indexPrefix = "full";

        //向量索引存储与加载
        createIndexTest(pq, indexDir, indexPrefix);

        //向量索引加载与访问
        log.info("查询向量:{}", Arrays.toString(floatVector));
        loadIndexTest(pq, indexDir, indexPrefix, clusterTopn, topn);
    }
}
